# CGCNN (Crystal Graph Convolutional Neural Networks) 詳解

這份文件詳細介紹了 **CGCNN** 模型，這是我们在 Phase 1 中使用的基準模型，也是材料科學 AI 領域的「開山之作」。

---

## 1. 什麼是 CGCNN？
*   **全名**：Crystal Graph Convolutional Neural Networks
*   **發表年份**：2018 (PRL, Xie & Grossman)
*   **核心思想**：
    *   將晶體結構視為一張「圖 (Graph)」。
    *   **節點 (Nodes)**：代表原子 (Atom)，特徵包含原子序數、電負性等。
    *   **邊 (Edges)**：代表化學鍵 (Bond)，特徵是用高斯函數展開的原子間距 (Distance)。

## 2. 它的原理 (The Crystal Graph)
想像一個簡單的氯化鈉 (NaCl) 晶體：
*   **節點**：Na 和 Cl 原子。
*   **邊**：如果有两个原子靠得夠近（例如 < 5 埃），就在它們之間畫一條線。
*   **卷積 (Convolution)**：
    1.  每個原子「看」它的鄰居。
    2.  根據鄰居是誰（例如 Na 看到 Cl）以及距離有多遠，更新自己的狀態。
    3.  重複幾次後，每個原子都知道了周圍的化學環境。
    4.  最後把所有原子的狀態平均起來，得到整個晶體的特徵向量，用來預測性質。

---

## 3. 優點與缺點 (Pros & Cons)

### ✅ 優點 (Pros)
1.  **速度極快**：結構簡單，訓練和推理都非常快。
2.  **通用性強**：適用於任何晶體結構（不用像傳統方法那樣手動設計特徵）。
3.  **可解釋性**：可以分析哪個原子對性質貢獻最大。
4.  **數據效率**：在小數據集（幾千筆）上也能跑得不錯。

### ❌ 缺點 (Cons) — 也是我們需要 Phase 2 的原因
1.  **缺乏方向性 (Key Limitation)**：
    *   **只知道距離，不知道角度**。
    *   它無法區分三個原子是排成直線 (180°) 還是直角 (90°)，只要距離一樣，CGCNN 就認為它們是一樣的。
    *   這導致它在預測 **力學性質 (如 Shear Modulus, 剪切模量)** 或 **各向異性** 性質時表現很差。
2.  **無法區分同分異構體 (Polymorphs)**：
    *   如果兩個結構的原子間距分佈很像，但鍵角不同，CGCNN 會預測出相同的結果。

---

## 4. 類似的模型 (Similar Models in Evolution)

材料 AI 的發展史基本上就是解決「如何更好地描述結構」的歷史：

| 模型名稱 | 年份 | 特點 | 與 CGCNN 的差異 |
| :--- | :--- | :--- | :--- |
| **CGCNN** | 2018 | **基準 (Baseline)** | 只用距離，無角度。 |
| **SchNet** | 2018 | 連續濾波卷積 | 也是基於距離，但在分子動力學 (MD) 上更常用。 |
| **MEGNet** | 2019 | 加入全局狀態 (State) | 在圖中加入了一個「全局節點」(State)，適合預測與溫度/壓力相關的性質。 |
| **ALIGNN** | 2021 | **引入角度 (Line Graph)** | 構建了「線圖 (Line Graph)」，明確地將鍵角納入考慮。精度大幅提升。 |
| **MACE / NequIP** | 2022+ | **等變神經網路 (E3NN)** | **(我們 Phase 2 的主角)**。使用高階張量與球諧函數，不僅知道角度，還知道完整的旋轉對稱性。精度最高，計算最慢。 |

---

## 5. 它能算什麼？ (Target Properties)

雖然 CGCNN 是一張圖，但它的輸出通常是一個簡單的數字 (Scalar)。在這個專案 (Phase 1) 中，我們訓練它預測以下 **4 個核心物性**：

### 1️⃣ 形成能 (Formation Energy) - 最準確 ✅
*   **物理意義**：這個材料「穩不穩定」？
*   **單位**：eV/atom (電子伏特/原子)
*   **越低越好**：負值越低，代表材料越容易合成，不會自己分解。
*   **CGCNN 表現**：非常準確 (MAE ~0.06 eV/atom)。因為能量主要取決於化學鍵的強弱，而這跟「距離」高度相關，剛好是 CGCNN 的強項。

### 2️⃣ 帶隙 (Band Gap) - 還行 ⚠️
*   **物理意義**：導電嗎？(0 = 金屬, >0 = 半導體/絕緣體)
*   **單位**：eV
*   **CGCNN 表現**：還可以，但有時會把小帶隙的半導體誤判成金屬。這需要更精細的電子結構資訊。
*   **為什麼會錯？**
    1.  **電子結構太複雜**：帶隙不僅取決於原子距離，還取決於電子軌域 (Orbitals) 重疊的角度和對稱性。
    2.  **同分異構體 (Polymorphs)**：同樣是碳，石墨導電 (0 eV)，金剛石絕緣 (5.5 eV)。它們原子距離差別不大，但結構差別巨大。CGCNN 很難區分這種微小的結構差異造成的巨大性質變化。

### 3️⃣ 體積模量 (Bulk Modulus) - 還行 ⚠️
*   **物理意義**：**「硬不硬？」** (抗壓縮能力)
*   **單位**：GPa
*   **直觀理解**：你用手用力捏它，它會縮小嗎？鑽石很高，海綿很低。
*   **CGCNN 表現**：尚可。因為壓縮主要改變的是「原子間距」，這也是 CGCNN 擅長的。
*   **為什麼會錯？**
    1.  **各向異性 (Anisotropy)**：很多材料在一個方向很硬，另一個方向很軟（例如層狀材料）。CGCNN 把它們平均起來看，就會預測失準。
    2.  **空隙結構**：有些籠狀結構看起來很緻密（原子很多），但其實中間是空的，很容易壓扁。CGCNN 只看局部連接，很難理解這種「整體架構」的脆弱性。

### 4️⃣ 剪切模量 (Shear Modulus) - 最差 ❌
*   **物理意義**：**「韌不韌？」** (抗變形能力)
*   **單位**：GPa
*   **直觀理解**：你用力扭毛巾，它會變形嗎？
*   **CGCNN 表現**：**非常差** (R² ~ 0.2)。
*   **為什麼？** 因為剪切變形涉及 **「角度的改變」** (把正方形壓成平行四邊形)，但原子間距可能沒變。CGCNN 看不到角度，所以它對剪切模量幾乎是瞎猜。這就是為什麼我們需要 Phase 2。

---

## 6. 常見問題與挑戰
我们在 `scripts/11_train_cgcnn_full.py` 中遇到的問題：

1.  **資料雜訊 (Outliers)**：DF 運算偶爾會收斂到錯誤的極端值，CGCNN 對這些雜訊很敏感（Loss 會爆炸）。這就是為什麼我們加了 `filter_outliers`。
2.  **梯度消失/爆炸**：在深層 GNN (層數 > 5) 中常見，通常用 Residual Connection (殘差連接) 解決。
3.  **泛化能力**：在訓練集 (Training Set) 表現很好，但在沒見過的化學元素組合上可能會失效。

---

## 總結
CGCNN 是一個很好的「起點」。它證明了 AI 可以從結構預測性質。
但它的「角度盲區」限制了它的上限。
這就是為什麼我們在這個專案中：
*   **Phase 1** 用 CGCNN 建立基準 (60分)。
*   **Phase 2** 用 MACE/E3NN 追求極致精度 (90分+)。
